<form class="creditsDetectorForm">
    <div class="paper-card" style="padding: 1.5em; margin-top: 2em;">
        <h2 style="margin-top:0;">General Settings</h2>

        <div class="checkboxContainer">
            <label>
                <input is="emby-checkbox" type="checkbox" id="chkEnableAutoDetection" data-config-key="EnableAutoDetection" />
                <span>Enable Automatic Detection</span>
            </label>
            <div class="fieldDescription">Automatically process new episodes as they are added to the library</div>
        </div>

        <div class="checkboxContainer">
            <label>
                <input is="emby-checkbox" type="checkbox" id="chkUseSeriesAveraging" data-config-key="UseSeriesAveraging" />
                <span>Use Series Averaging</span>
            </label>
            <div class="fieldDescription">Remember successful timestamps for each series and apply the average to failed episodes (helps with inconsistent detection)</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtMinimumEpisodesForAveraging">Minimum Episodes for Averaging</label>
            <input is="emby-input" type="number" id="txtMinimumEpisodesForAveraging" data-config-key="MinimumEpisodesForAveraging" step="1" min="1" max="100" />
            <div class="fieldDescription">Minimum number of successful episodes needed before applying average to failed episodes (default: 3)</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtTempFolderPath">Custom Temp Folder Path</label>
            <div style="display: flex; gap: 0.5em;">
                <input is="emby-input" type="text" id="txtTempFolderPath" data-config-key="TempFolderPath" style="flex: 1;" />
                <button is="emby-button" type="button" class="raised button-submit" id="btnBrowseTempFolder" title="Browse for folder">
                    <i class="md-icon">folder_open</i>
                </button>
            </div>
            <div class="fieldDescription"><strong style="color: #E5A54A;">⚠️ CRITICAL FOR DOCKER USERS:</strong> Set this to prevent filling your Docker image! Leave empty only if running Emby natively on host OS. Temp files are automatically cleaned up after processing.</div>
        </div>

        <div class="checkboxContainer" style="margin-top: 1.5em;">
            <label>
                <input is="emby-checkbox" type="checkbox" id="chkEnableDetailedLogging" data-config-key="EnableDetailedLogging" />
                <span>Enable Detailed Logging</span>
            </label>
            <div class="fieldDescription">Log detailed detection information to server logs (errors are always logged)</div>
        </div>

        <div style="margin-top: 1.5em;">
            <h3 style="color: #52B54B;">Library Selection</h3>
            <div class="fieldDescription" style="margin-bottom: 1em;">Choose which TV Show or Mixed libraries to enable credits detection. If none are selected, all TV Show and Mixed libraries will be used.</div>

            <div style="margin-bottom: 1em;">
                <label style="display: block; font-weight: bold; margin-bottom: 0.5em;">Enabled Libraries:</label>
                <div id="creditsLibraries" style="margin-left: 1em;"></div>
                <div class="fieldDescription" style="margin-top: 0.5em;">Libraries where automatic detection and scheduled tasks will run</div>
            </div>

            <div class="checkboxContainer" style="margin-top: 1em;">
                <label>
                    <input is="emby-checkbox" type="checkbox" id="chkScheduledTaskOnlyProcessMissing" data-config-key="ScheduledTaskOnlyProcessMissing" />
                    <span>Smart Processing (Only Process Missing Credits)</span>
                </label>
                <div class="fieldDescription">When enabled, the scheduled task will skip episodes that already have credits, only processing new episodes or those without credits. This significantly reduces processing time.</div>
            </div>

            <div class="checkboxContainer" style="margin-top: 1em;">
                <label>
                    <input is="emby-checkbox" type="checkbox" id="chkSkipPreviouslyProcessedFiles" data-config-key="SkipPreviouslyProcessedFiles" />
                    <span>Skip Previously Processed Files</span>
                </label>
                <div class="fieldDescription">Keep track of files that have already been processed for detection and skip them in future runs. The tracking file is saved in the configured temp folder.</div>
            </div>

            <div class="checkboxContainer" style="margin-top: 1em;">
                <label>
                    <input is="emby-checkbox" type="checkbox" id="chkSkipOnlySuccessfulFiles" data-config-key="SkipOnlySuccessfulFiles" />
                    <span>Skip Only Successful Files</span>
                </label>
                <div class="fieldDescription">When enabled along with "Skip Previously Processed Files", only skip files where detection was successful. Failed detections will be retried on future runs.</div>
            </div>

            <div style="margin-top: 1em;">
                <button is="emby-button" type="button" class="raised button-cancel" id="btnClearProcessedFiles">
                    <i class="md-icon">delete</i>
                    <span>Clear Processed Files List</span>
                </button>
                <div class="fieldDescription">Remove all entries from the processed files tracking list. Next run will process all files again.</div>
            </div>
        </div>
    </div>

    <div class="paper-card" style="padding: 1.5em; margin-top: 2em;">
        <h2 style="margin-top:0;">Performance & Resource Control</h2>
        
        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtDelayBetweenEpisodesMs">Delay Between Episodes (ms)</label>
            <input is="emby-input" type="number" id="txtDelayBetweenEpisodesMs" data-config-key="DelayBetweenEpisodesMs" min="0" max="60000" step="1000" />
            <div class="fieldDescription"><strong>Recommended: 0 (no delay).</strong> Add delay between processing each episode to reduce sustained system load. Use 2000-5000ms on slower machines. This is the delay between episodes, not between frames.</div>
        </div>
    </div>

    <div class="paper-card" style="padding: 1.5em; margin-top: 2em; border-left: 4px solid #52B54B;">
        <h2 style="margin-top: 0; color: #52B54B;">OCR Detection Settings</h2>
        <p class="fieldDescription">OCR detection is always enabled. Configure the settings below. Requires Docker container running (see Setup Guide tab).</p>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrEndpoint">OCR API Endpoint</label>
            <input is="emby-input" type="text" id="txtOcrEndpoint" data-config-key="OcrEndpoint" />
            <div class="fieldDescription">URL of your OCR API (e.g., <code>http://localhost:8884</code> or <code>http://192.168.1.100:8884</code>)</div>
            <div style="display: flex; align-items: center; gap: 0.5em; margin-top: 0.5em;">
                <button is="emby-button" type="button" class="raised button-submit" id="btnTestOcrConnection">
                    <i class="md-icon">check_circle</i>
                    <span>Test Connection</span>
                </button>
                <span id="ocrTestSuccess" style="display: none; color: #52B54B; font-size: 1.5em;">✓</span>
            </div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrDetectionKeywords">OCR Keywords (comma-separated)</label>
            <input is="emby-input" type="text" id="txtOcrDetectionKeywords" data-config-key="OcrDetectionKeywords" />
            <div class="fieldDescription">Keywords to search for in OCR text (case insensitive). Example: <code>directed by,cast,credits,produced by,executive producer,written by,created by</code></div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrSearchStartValue">Search Start Position</label>
            <div style="display: flex; gap: 0.5em; align-items: flex-start;">
                <input is="emby-input" type="number" step="0.5" id="txtOcrSearchStartValue" data-config-key="OcrSearchStartValue" style="flex: 1;" />
                <select is="emby-select" id="selectOcrSearchStartUnit" data-config-key="OcrSearchStartUnit" style="width: 150px;">
                    <option value="minutes">Minutes from End</option>
                    <option value="percentage">Percentage (%)</option>
                </select>
            </div>
            <div class="fieldDescription" id="ocrSearchStartDescription">
                <strong>Recommended: 2-3 minutes from end.</strong><br>
                <span id="descMinutes"><strong>Minutes from End:</strong> Start OCR this many minutes before video end (e.g., 3.0 = start at 47:00 in a 50 min video)</span>
                <span id="descPercentage" style="display: none;"><strong>Percentage:</strong> Where to start in the video (e.g., 65 = start 65% through, or at 32:30 in a 50 min video)</span>
            </div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrFrameRate">Frame Rate (fps)</label>
            <input is="emby-input" type="number" step="0.25" id="txtOcrFrameRate" data-config-key="OcrFrameRate" min="0.25" max="3" />
            <div class="fieldDescription"><strong>Recommended: 0.5 fps</strong> (1 frame every 2 seconds - fast & sufficient). Credits are static for several seconds, so no need to check every frame. Lower = faster!</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrMinimumMatches">Minimum Keyword Matches</label>
            <input is="emby-input" type="number" id="txtOcrMinimumMatches" data-config-key="OcrMinimumMatches" min="1" max="5" />
            <div class="fieldDescription"><strong>Recommended: 1.</strong> Minimum number of keyword detections within 10 seconds to confirm credits</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrMaxFramesToProcess">Max Frames to Process (0=unlimited)</label>
            <input is="emby-input" type="number" id="txtOcrMaxFramesToProcess" data-config-key="OcrMaxFramesToProcess" min="0" max="1000" />
            <div class="fieldDescription">Limit frames for faster testing (0=no limit for production, default: 0)</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrMaxAnalysisDuration">Max Analysis Duration (seconds)</label>
            <input is="emby-input" type="number" id="txtOcrMaxAnalysisDuration" data-config-key="OcrMaxAnalysisDuration" min="0" step="60" />
            <div class="fieldDescription"><strong>Recommended: 600 seconds (10 minutes).</strong> Maximum seconds of video to analyze. Prevents excessive processing on long videos. Set to 0 for unlimited.</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrStopSecondsFromEnd">Stop Seconds Before End</label>
            <input is="emby-input" type="number" id="txtOcrStopSecondsFromEnd" data-config-key="OcrStopSecondsFromEnd" min="0" max="120" />
            <div class="fieldDescription"><strong>Recommended: 20 seconds.</strong> Stop analyzing when this close to the end of the video. No reason to process the last few seconds where credits rarely start. Set to 0 to disable.</div>
        </div>

        <div class="selectContainer">
            <label class="selectLabel" for="selectOcrImageFormat">Image Format</label>
            <select is="emby-select" id="selectOcrImageFormat" data-config-key="OcrImageFormat">
                <option value="png">PNG (Higher quality, slower)</option>
                <option value="jpg">JPEG (Faster, smaller files)</option>
            </select>
            <div class="fieldDescription"><strong>Recommended: JPEG for speed.</strong> JPEG is 3-5x faster with smaller files and works well for large credit text. PNG is higher quality but slower.</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrJpegQuality">JPEG Quality (1-100)</label>
            <input is="emby-input" type="number" id="txtOcrJpegQuality" data-config-key="OcrJpegQuality" min="1" max="100" />
            <div class="fieldDescription"><strong>Recommended: 92.</strong> Only used when Image Format is JPEG. Higher = better quality but larger files. 85-95 is ideal for OCR.</div>
        </div>

        <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="txtOcrDelayBetweenFramesMs">Delay Between Frames (ms)</label>
            <input is="emby-input" type="number" id="txtOcrDelayBetweenFramesMs" data-config-key="OcrDelayBetweenFramesMs" min="0" max="5000" step="100" />
            <div class="fieldDescription"><strong>Recommended: 0 (no delay).</strong> Add delay between processing frames to reduce load on slower machines. Use 500-1000ms on very slow systems. Higher values = slower processing but less resource usage.</div>
        </div>

        <div style="margin-top: 2em; padding-top: 1.5em; border-top: 2px solid rgba(82, 181, 75, 0.3);">
            <h3 style="color: #52B54B; margin-top: 0;">Performance Optimizations</h3>
            
            <div class="checkboxContainer">
                <label>
                    <input is="emby-checkbox" type="checkbox" id="chkOcrEnableParallelProcessing" data-config-key="OcrEnableParallelProcessing" />
                    <span>Enable Parallel OCR Processing</span>
                </label>
                <div class="fieldDescription"><strong>⚠️ Advanced - Disabled by default.</strong> Process multiple frames simultaneously for 2-3x speed improvement. May stress slower systems or OCR servers. Only enable if you have a powerful system and OCR server.</div>
            </div>

            <div class="inputContainer">
                <label class="inputLabel inputLabelUnfocused" for="txtOcrParallelBatchSize">Parallel Batch Size</label>
                <input is="emby-input" type="number" id="txtOcrParallelBatchSize" data-config-key="OcrParallelBatchSize" min="2" max="10" />
                <div class="fieldDescription"><strong>Recommended: 4.</strong> Number of frames to process in parallel when parallel processing is enabled. Higher = faster but more resource intensive.</div>
            </div>

            <div class="checkboxContainer">
                <label>
                    <input is="emby-checkbox" type="checkbox" id="chkOcrEnableSmartFrameSkipping" data-config-key="OcrEnableSmartFrameSkipping" />
                    <span>Enable Smart Frame Skipping</span>
                </label>
                <div class="fieldDescription"><strong>Recommended: Enabled.</strong> Once keywords are detected, skip ahead in larger chunks to find the exact credits start faster.</div>
            </div>

            <div class="inputContainer">
                <label class="inputLabel inputLabelUnfocused" for="txtOcrConsecutiveMatchesForEarlyStop">Consecutive Matches for Early Stop</label>
                <input is="emby-input" type="number" id="txtOcrConsecutiveMatchesForEarlyStop" data-config-key="OcrConsecutiveMatchesForEarlyStop" min="0" max="10" />
                <div class="fieldDescription"><strong>Recommended: 3.</strong> Stop processing after finding this many consecutive frames with keywords (0 = disabled). Speeds up detection when credits are found.</div>
            </div>

            <div class="inputContainer">
                <label class="inputLabel inputLabelUnfocused" for="txtOcrMinimumConfidence">Minimum OCR Confidence (0-1)</label>
                <input is="emby-input" type="number" step="0.1" id="txtOcrMinimumConfidence" data-config-key="OcrMinimumConfidence" min="0" max="1" />
                <div class="fieldDescription"><strong>Recommended: 0 (disabled).</strong> Minimum OCR confidence score to accept a match (0 = accept all). Set to 0.6-0.8 to filter out false positives. Requires OCR API that returns confidence scores.</div>
            </div>
        </div>
    </div>

    <div style="margin-top: 2em; display: flex; gap: 1em;">
        <button is="emby-button" type="submit" class="raised button-submit block" style="flex: 1;">
            <span>Save</span>
        </button>
        <button is="emby-button" type="button" class="raised block" id="btnResetToDefaults" style="flex: 1; background-color: #e67e22;">
            <i class="md-icon">restore</i>
            <span>Reset to Defaults</span>
        </button>
    </div>
</form>
